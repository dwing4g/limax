ARCH_I386 = i386
ARCH_X86_64 = x86_64
ARCH_ARMV7 = armv7
ARCH_ARMV7S = armv7s
ARCH_ARM64 = arm64

PLAT_MACOS = macos
PLAT_SIMULATOR = sim
PLAT_IOS = ios

ifeq ($(debug), true)
DEBUG_FLAG = debug=true
else
DEBUG_FLAG =
endif

ifeq ($(shared), true)
dynamic = true
endif

ifeq ($(dynamic), true)
LIB_EXT = dylib
else
LIB_EXT = a
endif

DESTLIMAXLIB = liblimax
DESTLIBS_MACOS = $(DESTLIMAXLIB).$(PLAT_MACOS).$(ARCH_I386).$(LIB_EXT) $(DESTLIMAXLIB).$(PLAT_MACOS).$(ARCH_X86_64).$(LIB_EXT)
DESTLIBS_IOS = $(DESTLIMAXLIB).$(PLAT_SIMULATOR).$(ARCH_I386).$(LIB_EXT) $(DESTLIMAXLIB).$(PLAT_SIMULATOR).$(ARCH_X86_64).$(LIB_EXT) \
        $(DESTLIMAXLIB).$(PLAT_IOS).$(ARCH_ARMV7).$(LIB_EXT) $(DESTLIMAXLIB).$(PLAT_IOS).$(ARCH_ARMV7S).$(LIB_EXT) \
		$(DESTLIMAXLIB).$(PLAT_IOS).$(ARCH_ARM64).$(LIB_EXT)

DEVELOPER_MACOS = /Applications/Xcode.app/Contents/Developer/Platforms/MacOSX.platform/Developer
SDKPATH_MACOS = $(DEVELOPER_MACOS)/SDKs/MacOSX.sdk

DEVELOPER_IOS = /Applications/Xcode.app/Contents/Developer/Platforms/iPhoneOS.platform/Developer
SDKPATH_IOS = $(DEVELOPER_IOS)/SDKs/iPhoneOS.sdk
DEVELOPER_SIMULATOR = /Applications/Xcode.app/Contents/Developer/Platforms/iPhoneSimulator.platform/Developer
SDKPATH_SIMULATOR = $(DEVELOPER_SIMULATOR)/SDKs/iPhoneSimulator.sdk

ifeq ($(dynamic), true)
LIBTOOL_MACOS = ld
LIBTOOL_IOS = ld #$(DEVELOPER_IOS)/usr/bin/ld
LIBTOOL_SIMULATOR = ld #$(DEVELOPER_SIMULATOR)/usr/bin/ld
else
LIBTOOL_MACOS = libtool
LIBTOOL_IOS = libtool #$(DEVELOPER_IOS)/usr/bin/libtool
LIBTOOL_SIMULATOR = libtool
endif

LIB_MACOS_I386_VARS = DESTLIMAXLIB=$(DESTLIMAXLIB) ARCHFLAG=$(ARCH_I386) PLATFLAG=$(PLAT_MACOS) LIB_EXT=$(LIB_EXT) DEVELOPER=$(DEVELOPER_MACOS) SDKPATH=$(SDKPATH_MACOS) dynamic=$(dynamic) $(DEBUG_FLAG) LIBTOOL=$(LIBTOOL_MACOS)
LIB_MACOS_X86_64_VARS = DESTLIMAXLIB=$(DESTLIMAXLIB) ARCHFLAG=$(ARCH_X86_64) PLATFLAG=$(PLAT_MACOS) LIB_EXT=$(LIB_EXT) DEVELOPER=$(DEVELOPER_MACOS) SDKPATH=$(SDKPATH_MACOS) dynamic=$(dynamic) $(DEBUG_FLAG) LIBTOOL=$(LIBTOOL_MACOS)
LIB_IOS_ARMV7_VARS = DESTLIMAXLIB=$(DESTLIMAXLIB) ARCHFLAG=$(ARCH_ARMV7) PLATFLAG=$(PLAT_IOS) LIB_EXT=$(LIB_EXT) DEVELOPER=$(DEVELOPER_IOS) SDKPATH=$(SDKPATH_IOS) dynamic=$(dynamic) $(DEBUG_FLAG) LIBTOOL=$(LIBTOOL_IOS)
LIB_IOS_ARMV7S_VARS = DESTLIMAXLIB=$(DESTLIMAXLIB) ARCHFLAG=$(ARCH_ARMV7S) PLATFLAG=$(PLAT_IOS) LIB_EXT=$(LIB_EXT) DEVELOPER=$(DEVELOPER_IOS) SDKPATH=$(SDKPATH_IOS) dynamic=$(dynamic) $(DEBUG_FLAG) LIBTOOL=$(LIBTOOL_IOS)
LIB_IOS_ARM64_VARS = DESTLIMAXLIB=$(DESTLIMAXLIB) ARCHFLAG=$(ARCH_ARM64) PLATFLAG=$(PLAT_IOS) LIB_EXT=$(LIB_EXT) DEVELOPER=$(DEVELOPER_IOS) SDKPATH=$(SDKPATH_IOS) dynamic=$(dynamic) $(DEBUG_FLAG) LIBTOOL=$(LIBTOOL_IOS)
LIB_SIMULATOR_I386_VARS = DESTLIMAXLIB=$(DESTLIMAXLIB) ARCHFLAG=$(ARCH_I386) PLATFLAG=$(PLAT_SIMULATOR) LIB_EXT=$(LIB_EXT) DEVELOPER=$(DEVELOPER_SIMULATOR) SDKPATH=$(SDKPATH_SIMULATOR) dynamic=$(dynamic) $(DEBUG_FLAG) LIBTOOL=$(LIBTOOL_SIMULATOR)
LIB_SIMULATOR_X86_64_VARS = DESTLIMAXLIB=$(DESTLIMAXLIB) ARCHFLAG=$(ARCH_X86_64) PLATFLAG=$(PLAT_SIMULATOR) LIB_EXT=$(LIB_EXT) DEVELOPER=$(DEVELOPER_SIMULATOR) SDKPATH=$(SDKPATH_SIMULATOR) dynamic=$(dynamic) $(DEBUG_FLAG) LIBTOOL=$(LIBTOOL_SIMULATOR)

LIPO_MACOS = lipo
LIPO_IOS = lipo #$(DEVELOPER_IOS)/usr/bin/lipo

ifeq ($(dynamic), true)
MAIN_DEPS = $(DESTLIBS_MACOS) $(DESTLIBS_IOS)
else
MAIN_DEPS = $(DESTLIMAXLIB).$(PLAT_MACOS).$(LIB_EXT) $(DESTLIMAXLIB).$(PLAT_IOS).$(LIB_EXT)
endif

main : $(MAIN_DEPS)

$(DESTLIMAXLIB).$(PLAT_MACOS).$(LIB_EXT) : $(DESTLIBS_MACOS)
	$(LIPO_MACOS) -create -output $(DESTLIMAXLIB).$(PLAT_MACOS).a $(DESTLIBS_MACOS)

$(DESTLIMAXLIB).$(PLAT_IOS).$(LIB_EXT) : $(DESTLIBS_IOS)
	$(LIPO_IOS) -create -output $(DESTLIMAXLIB).$(PLAT_IOS).a $(DESTLIBS_IOS)

$(DESTLIMAXLIB).$(PLAT_MACOS).$(ARCH_I386).$(LIB_EXT) :
	make -f makelib.mk $(LIB_MACOS_I386_VARS)

$(DESTLIMAXLIB).$(PLAT_MACOS).$(ARCH_X86_64).$(LIB_EXT) :
	make -f makelib.mk $(LIB_MACOS_X86_64_VARS)

$(DESTLIMAXLIB).$(PLAT_IOS).$(ARCH_ARMV7).$(LIB_EXT) :
	make -f makelib.mk $(LIB_IOS_ARMV7_VARS)

$(DESTLIMAXLIB).$(PLAT_IOS).$(ARCH_ARMV7S).$(LIB_EXT) :
	make -f makelib.mk $(LIB_IOS_ARMV7S_VARS)

$(DESTLIMAXLIB).$(PLAT_IOS).$(ARCH_ARM64).$(LIB_EXT) :
	make -f makelib.mk $(LIB_IOS_ARM64_VARS)

$(DESTLIMAXLIB).$(PLAT_SIMULATOR).$(ARCH_I386).$(LIB_EXT) :
	make -f makelib.mk $(LIB_SIMULATOR_I386_VARS)

$(DESTLIMAXLIB).$(PLAT_SIMULATOR).$(ARCH_X86_64).$(LIB_EXT) :
	make -f makelib.mk $(LIB_SIMULATOR_X86_64_VARS)

dev : $(DESTLIMAXLIB).$(PLAT_MACOS).$(ARCH_X86_64).$(LIB_EXT)

all : clean main 

clean :
	make -f makelib.mk $(LIB_MACOS_I386_VARS) clean
	make -f makelib.mk $(LIB_MACOS_X86_64_VARS) clean
	make -f makelib.mk $(LIB_IOS_ARMV7_VARS) clean
	make -f makelib.mk $(LIB_IOS_ARMV7S_VARS) clean
	make -f makelib.mk $(LIB_IOS_ARM64_VARS) clean
	make -f makelib.mk $(LIB_SIMULATOR_I386_VARS) clean
	make -f makelib.mk $(LIB_SIMULATOR_X86_64_VARS) clean
	$(RM) $(DESTLIMAXLIB).$(PLAT_MACOS).$(LIB_EXT) $(DESTLIMAXLIB).$(PLAT_IOS).$(LIB_EXT)
	
